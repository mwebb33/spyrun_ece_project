#!/usr/bin/env nodejs
var app = require('../app');
var debug = require('debug')('test');
var server = require('http').createServer(app);
var io = require('socket.io').listen(server);  //pass a http.Server instance
console.log("socket.io started")

server.listen(app.get('port'));

var obj = new Object();
var charState; 

var sockets = {};
var connectionIDCounter = 0;

app.get('/', function (req, res) {
  res.sendfile(__dirname + '/index.html');
});

io.on('connection', function (socket) {

  socket.id = connectionIDCounter++;
  sockets[socket.id] = socket;

  console.log("socket.io client connected Id: " + socket.id);

  socket.on('client', function (data) {
      var clientMsg = JSON.parse(data);
      obj[socket.id] = data;
      charState = JSON.stringify(obj);
      console.log("state: " + charState)
      propigate();
  });

  socket.on('reqID', function (data) {
      console.log(data);
      var clientMsg = data;
      clientMsg.id = socket.id; 
      console.log("replying to ID with: " + socket.id); 
      rspMsg = JSON.stringify(clientMsg);
      socket.emit('resID', rspMsg);
  });

  socket.on('disconnect', function (data) {
    console.log("Socket.io connection closed Id: " + socket.id);
    clearInterval(socket.id);
    delete sockets[socket.id];
    delete obj[socket.id];
    charState = JSON.stringify(obj);
    alertDrop(socket.id);
  });

});

function propigate() {
  //console.log("hi");
  for (var index = 0; index < connectionIDCounter; index++){
    if(sockets[index] != undefined){
      sockets[index].emit('state', charState);
    }
  }
}

function alertDrop(dropID) {
  //console.log("hi");
  for (var index = 0; index < connectionIDCounter; index++){
    if(sockets[index] != undefined){
      sockets[index].emit('playerleft', { id: dropID });
    }
  }
}

